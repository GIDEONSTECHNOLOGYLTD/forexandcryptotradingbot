<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot - User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .status-running {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-robot text-3xl mr-3"></i>
                    <h1 class="text-2xl font-bold">Trading Bot Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userName" class="text-sm"></span>
                    <span id="userPlan" class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs"></span>
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 rounded hover:bg-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-96">
            <div class="text-center mb-8">
                <i class="fas fa-robot text-6xl text-purple-600 mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-800">Welcome Back</h2>
                <p class="text-gray-600">Login to your trading dashboard</p>
            </div>
            <form onsubmit="login(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" required
                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
                           placeholder="your@email.com">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" required
                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
                           placeholder="••••••••">
                </div>
                <button type="submit" 
                        class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90">
                    Login
                </button>
            </form>
            <div class="mt-4 text-center">
                <a href="#" onclick="showRegister()" class="text-purple-600 hover:underline">
                    Don't have an account? Register
                </a>
            </div>
        </div>
    </div>

    <!-- Register Screen -->
    <div id="registerScreen" class="hidden min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-96">
            <div class="text-center mb-8">
                <i class="fas fa-user-plus text-6xl text-purple-600 mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-800">Create Account</h2>
                <p class="text-gray-600">Start trading today</p>
            </div>
            <form onsubmit="register(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="registerName" required
                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Email</label>
                    <input type="email" id="registerEmail" required
                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Password</label>
                    <input type="password" id="registerPassword" required
                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                </div>
                <button type="submit" 
                        class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90">
                    Create Account
                </button>
            </form>
            <div class="mt-4 text-center">
                <a href="#" onclick="showLogin()" class="text-purple-600 hover:underline">
                    Already have an account? Login
                </a>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Stats Cards -->
        <div class="container mx-auto px-6 py-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <!-- Total Capital -->
                <div class="card bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total Capital</p>
                            <h3 id="totalCapital" class="text-2xl font-bold text-gray-800">$0.00</h3>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-dollar-sign text-green-600 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Total PnL -->
                <div class="card bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total PnL</p>
                            <h3 id="totalPnL" class="text-2xl font-bold">$0.00</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-chart-line text-blue-600 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Win Rate -->
                <div class="card bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Win Rate</p>
                            <h3 id="winRate" class="text-2xl font-bold text-gray-800">0%</h3>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <i class="fas fa-trophy text-purple-600 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Active Bots -->
                <div class="card bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Active Bots</p>
                            <h3 id="activeBots" class="text-2xl font-bold text-gray-800">0</h3>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <i class="fas fa-robot text-yellow-600 text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Performance Chart -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Performance Chart</h3>
                    <canvas id="performanceChart"></canvas>
                </div>

                <!-- Trade Distribution -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Trade Distribution</h3>
                    <canvas id="tradeChart"></canvas>
                </div>
            </div>

            <!-- Bots Section -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold">My Trading Bots</h3>
                    <button onclick="showCreateBot()" 
                            class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90">
                        <i class="fas fa-plus mr-2"></i>Create New Bot
                    </button>
                </div>
                <div id="botsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Bots will be loaded here -->
                </div>
            </div>

            <!-- Recent Trades -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4">Recent Trades</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">Symbol</th>
                                <th class="text-left py-3 px-4">Side</th>
                                <th class="text-left py-3 px-4">Entry</th>
                                <th class="text-left py-3 px-4">Exit</th>
                                <th class="text-left py-3 px-4">PnL</th>
                                <th class="text-left py-3 px-4">Date</th>
                            </tr>
                        </thead>
                        <tbody id="tradesTable">
                            <!-- Trades will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Bot Modal -->
    <div id="createBotModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-8 w-96">
            <h3 class="text-2xl font-bold mb-4">Create New Bot</h3>
            <form onsubmit="createBot(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Initial Capital</label>
                    <input type="number" id="botCapital" value="10000" required
                           class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Trading Mode</label>
                    <select id="botMode" class="w-full px-4 py-2 border rounded-lg">
                        <option value="true">Paper Trading (Safe)</option>
                        <option value="false">Live Trading</option>
                    </select>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" 
                            class="flex-1 gradient-bg text-white py-2 rounded-lg">
                        Create
                    </button>
                    <button type="button" onclick="hideCreateBot()"
                            class="flex-1 bg-gray-300 py-2 rounded-lg">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let token = localStorage.getItem('token');
        let currentUser = null;

        // Initialize
        if (token) {
            loadDashboard();
        } else {
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // Authentication
        async function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                if (response.ok) {
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    currentUser = data.user;
                    loadDashboard();
                } else {
                    alert('Login failed: ' + data.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function register(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email, 
                        password, 
                        full_name: name,
                        role: 'user'
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    alert('Registration successful! Please login.');
                    showLogin();
                } else {
                    alert('Registration failed: ' + data.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        function showLogin() {
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showRegister() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.remove('hidden');
        }

        // Dashboard
        async function loadDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('registerScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            await loadUserInfo();
            await loadBots();
            await loadTrades();
            await loadStats();
            initCharts();
        }

        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_URL}/api/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await response.json();
                document.getElementById('userName').textContent = user.full_name;
                document.getElementById('userPlan').textContent = user.subscription.toUpperCase();
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        async function loadBots() {
            try {
                const response = await fetch(`${API_URL}/api/bots/my-bots`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const bots = await response.json();
                
                const botsList = document.getElementById('botsList');
                botsList.innerHTML = bots.map(bot => `
                    <div class="card border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-bold">Bot #${bot._id.slice(-6)}</h4>
                            <span class="px-2 py-1 rounded text-xs ${bot.status === 'running' ? 'bg-green-100 text-green-800 status-running' : 'bg-gray-100 text-gray-800'}">
                                ${bot.status}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">
                            Capital: $${bot.config.initial_capital.toLocaleString()}
                        </p>
                        <div class="flex space-x-2">
                            ${bot.status === 'stopped' ? 
                                `<button onclick="startBot('${bot._id}')" class="flex-1 bg-green-500 text-white py-1 rounded text-sm">Start</button>` :
                                `<button onclick="stopBot('${bot._id}')" class="flex-1 bg-red-500 text-white py-1 rounded text-sm">Stop</button>`
                            }
                            <button onclick="viewBot('${bot._id}')" class="flex-1 bg-blue-500 text-white py-1 rounded text-sm">View</button>
                        </div>
                    </div>
                `).join('');

                document.getElementById('activeBots').textContent = bots.filter(b => b.status === 'running').length;
            } catch (error) {
                console.error('Error loading bots:', error);
            }
        }

        async function loadTrades() {
            // Placeholder - implement actual API call
            const tradesTable = document.getElementById('tradesTable');
            tradesTable.innerHTML = `
                <tr><td colspan="6" class="text-center py-4 text-gray-500">No trades yet</td></tr>
            `;
        }

        async function loadStats() {
            // Placeholder - implement actual API call
            document.getElementById('totalCapital').textContent = '$10,000.00';
            document.getElementById('totalPnL').textContent = '$0.00';
            document.getElementById('winRate').textContent = '0%';
        }

        function initCharts() {
            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Capital',
                        data: [10000, 10050, 10100, 10080, 10150, 10200, 10250],
                        borderColor: 'rgb(102, 126, 234)',
                        tension: 0.1
                    }]
                }
            });

            // Trade Distribution
            const tradeCtx = document.getElementById('tradeChart').getContext('2d');
            new Chart(tradeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Wins', 'Losses'],
                    datasets: [{
                        data: [60, 40],
                        backgroundColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)']
                    }]
                }
            });
        }

        // Bot Management
        function showCreateBot() {
            document.getElementById('createBotModal').classList.remove('hidden');
        }

        function hideCreateBot() {
            document.getElementById('createBotModal').classList.add('hidden');
        }

        async function createBot(event) {
            event.preventDefault();
            const capital = document.getElementById('botCapital').value;
            const paperTrading = document.getElementById('botMode').value === 'true';

            try {
                const userResponse = await fetch(`${API_URL}/api/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await userResponse.json();

                const response = await fetch(`${API_URL}/api/bots/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: user._id,
                        initial_capital: parseFloat(capital),
                        paper_trading: paperTrading
                    })
                });

                if (response.ok) {
                    alert('Bot created successfully!');
                    hideCreateBot();
                    loadBots();
                } else {
                    alert('Failed to create bot');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function startBot(botId) {
            try {
                const response = await fetch(`${API_URL}/api/bots/${botId}/start`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    loadBots();
                }
            } catch (error) {
                console.error('Error starting bot:', error);
            }
        }

        async function stopBot(botId) {
            try {
                const response = await fetch(`${API_URL}/api/bots/${botId}/stop`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    loadBots();
                }
            } catch (error) {
                console.error('Error stopping bot:', error);
            }
        }

        function viewBot(botId) {
            alert('Bot details for: ' + botId);
        }
    </script>
</body>
</html>
