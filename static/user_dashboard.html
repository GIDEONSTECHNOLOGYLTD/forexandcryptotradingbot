<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Pro - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { transition: all 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .status-running { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .btn-primary { @apply px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition; }
        .btn-success { @apply px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition; }
        .btn-danger { @apply px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav id="mainNav" class="gradient-bg text-white shadow-lg hidden">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-robot text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Trading Bot Pro</h1>
                        <p class="text-sm opacity-80" id="userName"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userPlan" class="px-4 py-2 bg-white bg-opacity-20 rounded-full text-sm font-semibold"></span>
                    <button onclick="showSettings()" class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 rounded-lg hover:bg-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-robot text-6xl text-purple-600 mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-800">Welcome Back</h2>
                <p class="text-gray-600">Sign in to start trading</p>
            </div>
            <form onsubmit="login(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                </div>
                <button type="submit" class="w-full py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                    <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <div class="container mx-auto px-6 py-8">
            
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">OKX Balance</p>
                            <h3 class="text-3xl font-bold text-gray-800" id="okxBalance">$0.00</h3>
                            <p class="text-xs text-gray-400 mt-1" id="balanceStatus">Not connected</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-full">
                            <i class="fas fa-wallet text-2xl text-purple-600"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total Capital</p>
                            <h3 class="text-3xl font-bold text-gray-800" id="totalCapital">$0.00</h3>
                        </div>
                        <div class="bg-green-100 p-4 rounded-full">
                            <i class="fas fa-dollar-sign text-2xl text-green-600"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total P&L</p>
                            <h3 class="text-3xl font-bold" id="totalPnL">$0.00</h3>
                        </div>
                        <div class="bg-blue-100 p-4 rounded-full">
                            <i class="fas fa-chart-line text-2xl text-blue-600"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Win Rate</p>
                            <h3 class="text-3xl font-bold text-gray-800" id="winRate">0%</h3>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-full">
                            <i class="fas fa-trophy text-2xl text-purple-600"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Active Bots</p>
                            <h3 class="text-3xl font-bold text-gray-800" id="activeBots">0</h3>
                        </div>
                        <div class="bg-yellow-100 p-4 rounded-full">
                            <i class="fas fa-robot text-2xl text-yellow-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Bot Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-plus-circle text-green-600 mr-3"></i>
                    Create New Bot
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Bot Type</label>
                        <select id="botType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                            <option value="momentum">Momentum Strategy</option>
                            <option value="grid">Grid Trading</option>
                            <option value="dca">DCA Bot</option>
                            <option value="mean_reversion">Mean Reversion</option>
                            <option value="breakout">Breakout</option>
                            <option value="scalping">Scalping</option>
                            <option value="swing">Swing Trading</option>
                            <option value="arbitrage">Arbitrage</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Trading Pair</label>
                        <select id="symbol" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                            <optgroup label="Crypto">
                                <option value="BTC/USDT">BTC/USDT</option>
                                <option value="ETH/USDT">ETH/USDT</option>
                                <option value="SOL/USDT">SOL/USDT</option>
                                <option value="DOGE/USDT">DOGE/USDT</option>
                                <option value="XRP/USDT">XRP/USDT</option>
                            </optgroup>
                            <optgroup label="Forex">
                                <option value="EUR/USD">EUR/USD</option>
                                <option value="GBP/USD">GBP/USD</option>
                                <option value="USD/JPY">USD/JPY</option>
                            </optgroup>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Initial Capital ($)</label>
                        <input type="number" id="capital" value="1000" min="100" step="100"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Trading Mode</label>
                        <select id="tradingMode" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                            <option value="true">Paper Trading (Safe)</option>
                            <option value="false">Real Trading (Live)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Risk Level</label>
                        <select id="riskLevel" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                            <option value="low">Low (1% per trade)</option>
                            <option value="medium" selected>Medium (2% per trade)</option>
                            <option value="high">High (3% per trade)</option>
                        </select>
                    </div>

                    <div class="flex items-end">
                        <button onclick="createBot()" class="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                            <i class="fas fa-rocket mr-2"></i>Create & Start Bot
                        </button>
                    </div>
                </div>
            </div>

            <!-- My Bots Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-robot text-purple-600 mr-3"></i>
                    My Trading Bots
                </h2>
                <div id="botsList" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">No bots yet. Create your first bot above!</p>
                </div>
            </div>

            <!-- Recent Trades -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-history text-blue-600 mr-3"></i>
                    Recent Trades
                </h2>
                <div id="tradesList" class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">Time</th>
                                <th class="text-left py-3 px-4">Symbol</th>
                                <th class="text-left py-3 px-4">Type</th>
                                <th class="text-left py-3 px-4">Entry</th>
                                <th class="text-left py-3 px-4">Exit</th>
                                <th class="text-left py-3 px-4">P&L</th>
                            </tr>
                        </thead>
                        <tbody id="tradesTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-500">No trades yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Settings</h2>
                <button onclick="hideSettings()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Exchange Connection -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-4">Exchange Connection</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2">OKX API Key</label>
                        <input type="text" id="okxApiKey" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">OKX Secret Key</label>
                        <input type="password" id="okxSecretKey" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">OKX Passphrase</label>
                        <input type="password" id="okxPassphrase" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <button onclick="connectExchange()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Connect Exchange
                    </button>
                </div>
            </div>

            <!-- Subscription -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-4">Subscription</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div class="border rounded-lg p-4 text-center">
                        <h4 class="font-bold">Free</h4>
                        <p class="text-2xl font-bold my-2">$0</p>
                        <p class="text-sm text-gray-600">Paper trading only</p>
                    </div>
                    <div class="border-2 border-purple-600 rounded-lg p-4 text-center">
                        <h4 class="font-bold text-purple-600">Pro</h4>
                        <p class="text-2xl font-bold my-2">$29/mo</p>
                        <p class="text-sm text-gray-600">Real trading + 3 bots</p>
                        <button class="mt-2 px-4 py-2 bg-purple-600 text-white rounded-lg text-sm">Upgrade</button>
                    </div>
                    <div class="border rounded-lg p-4 text-center">
                        <h4 class="font-bold">Enterprise</h4>
                        <p class="text-2xl font-bold my-2">$99/mo</p>
                        <p class="text-sm text-gray-600">Unlimited bots</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let token = localStorage.getItem('token');
        let currentUser = null;

        // Initialize
        if (token) {
            loadDashboard();
        }

        // Login
        async function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Login failed');
                    return;
                }

                const data = await response.json();
                token = data.access_token;
                localStorage.setItem('token', token);
                currentUser = data.user;
                
                loadDashboard();
            } catch (error) {
                console.error('Login error:', error);
                alert('Login error: ' + error.message);
            }
        }

        // Load Dashboard
        async function loadDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainNav').classList.remove('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            await loadUserInfo();
            await loadBalance();
            await loadStats();
            await loadBots();
            await loadTrades();
            
            // Auto-refresh every 5 seconds
            setInterval(() => {
                loadStats();
                loadBots();
            }, 5000);
        }

        // Load User Info
        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_URL}/api/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await response.json();
                document.getElementById('userName').textContent = user.full_name || user.email;
                document.getElementById('userPlan').textContent = (user.subscription || 'free').toUpperCase();
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        // Load Balance
        async function loadBalance() {
            try {
                const response = await fetch(`${API_URL}/api/user/balance`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('okxBalance').textContent = '$' + data.total_usdt.toFixed(2);
                    document.getElementById('balanceStatus').textContent = data.account_type === 'admin' ? 'Admin Account' : 'Connected';
                    document.getElementById('balanceStatus').classList.add('text-green-500');
                } else {
                    document.getElementById('balanceStatus').textContent = data.error || 'Not connected';
                    document.getElementById('balanceStatus').classList.add('text-red-500');
                }
            } catch (error) {
                console.error('Error loading balance:', error);
            }
        }

        // Load Stats
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/api/bots/my-bots`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const bots = Array.isArray(await response.json()) ? await response.json() : [];
                
                let totalCapital = 0;
                let totalPnL = 0;
                let activeBots = 0;
                
                bots.forEach(bot => {
                    totalCapital += bot.config?.initial_capital || 0;
                    if (bot.status === 'running') activeBots++;
                });

                document.getElementById('totalCapital').textContent = `$${totalCapital.toFixed(2)}`;
                document.getElementById('totalPnL').textContent = `$${totalPnL.toFixed(2)}`;
                document.getElementById('activeBots').textContent = activeBots;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Create Bot
        async function createBot() {
            const config = {
                user_id: currentUser?.email || 'user',
                strategy: document.getElementById('botType').value,
                symbol: document.getElementById('symbol').value,
                initial_capital: parseFloat(document.getElementById('capital').value),
                paper_trading: document.getElementById('tradingMode').value === 'true',
                risk_level: document.getElementById('riskLevel').value
            };

            try {
                const response = await fetch(`${API_URL}/api/bots/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('‚úÖ Bot created successfully!');
                    loadBots();
                } else {
                    const error = await response.json();
                    alert('‚ùå Error: ' + error.detail);
                }
            } catch (error) {
                console.error('Error creating bot:', error);
                alert('‚ùå Error creating bot: ' + error.message);
            }
        }

        // Load Bots
        async function loadBots() {
            try {
                const response = await fetch(`${API_URL}/api/bots/my-bots`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const bots = await response.json();
                
                const botsList = document.getElementById('botsList');
                
                if (bots.length === 0) {
                    botsList.innerHTML = '<p class="text-gray-500 text-center py-8">No bots yet. Create your first bot above!</p>';
                    return;
                }

                botsList.innerHTML = bots.map(bot => `
                    <div class="border rounded-lg p-4 flex items-center justify-between hover:shadow-lg transition">
                        <div class="flex items-center space-x-4">
                            <div class="bg-purple-100 p-3 rounded-full">
                                <i class="fas fa-robot text-purple-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg">${bot.config?.strategy || 'Trading Bot'}</h3>
                                <p class="text-gray-600 text-sm">${bot.config?.symbol || 'BTC/USDT'} ‚Ä¢ $${bot.config?.initial_capital || 0}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${
                                bot.status === 'running' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                            }">
                                ${bot.status === 'running' ? 'üü¢ Running' : '‚ö´ Stopped'}
                            </span>
                            ${bot.status === 'running' ? 
                                `<button onclick="stopBot('${bot._id}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                    <i class="fas fa-stop mr-2"></i>Stop
                                </button>` :
                                `<button onclick="startBot('${bot._id}')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                    <i class="fas fa-play mr-2"></i>Start
                                </button>`
                            }
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading bots:', error);
            }
        }

        // Start Bot
        async function startBot(botId) {
            try {
                const response = await fetch(`${API_URL}/api/bots/${botId}/start`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('‚úÖ Bot started successfully!');
                    loadBots();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert('‚ùå Error: ' + error.detail);
                }
            } catch (error) {
                console.error('Error starting bot:', error);
                alert('‚ùå Error starting bot: ' + error.message);
            }
        }

        // Stop Bot
        async function stopBot(botId) {
            try {
                const response = await fetch(`${API_URL}/api/bots/${botId}/stop`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('‚úÖ Bot stopped successfully!');
                    loadBots();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert('‚ùå Error: ' + error.detail);
                }
            } catch (error) {
                console.error('Error stopping bot:', error);
                alert('‚ùå Error stopping bot: ' + error.message);
            }
        }

        // Load Trades
        async function loadTrades() {
            // Placeholder - will be implemented with real trade data
            console.log('Loading trades...');
        }

        // Connect Exchange
        async function connectExchange() {
            const credentials = {
                okx_api_key: document.getElementById('okxApiKey').value,
                okx_secret_key: document.getElementById('okxSecretKey').value,
                okx_passphrase: document.getElementById('okxPassphrase').value,
                paper_trading: false
            };

            try {
                const response = await fetch(`${API_URL}/api/user/connect-exchange`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(credentials)
                });

                if (response.ok) {
                    alert('‚úÖ Exchange connected successfully!');
                    hideSettings();
                } else {
                    const error = await response.json();
                    alert('‚ùå Error: ' + error.detail);
                }
            } catch (error) {
                console.error('Error connecting exchange:', error);
                alert('‚ùå Error connecting exchange: ' + error.message);
            }
        }

        // Settings Modal
        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function hideSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }
    </script>
</body>
</html>
